---
title: Day4
---

# Bioinformatics at the CLI: it's your turn

> Today you will be working on your own on a small project, putting together all the things you learned so far.
> 

## Task1

We will map short reads against a reference genome. Read the tasks first, as this is not a step-by-step tutorial.


### Preliminary steps 

1. :mag: **Locate the reads**. In our ["learn_bash" course repository](https://github.com/telatin/learn_bash) there is a directory
containing a set of paired end FASTQ files. It is common for FASTQ files to have the extension `.fastq.gz` (or `.fq.gz`),
as they are usually compressed with gzip.
:bulb: used the `find` command to locate all the FASTQ files in the repository. You should find a single directory containing all of them.

2. :book: **Reference genome**. In the `./phage/` subdirectory of the repository, you will find the files coming from the reference
genome sequence and its annotation. Common extensions for FASTA reference are `.fa`, `.fasta`, `.fna`. The annotation is supplied in
multiple formats, we will use the `.gff` annotation.

3. :gear: **Gathering the tools**. Create a new conda environment (using mamba) with the following tools:
   * *seqfu* for general FASTA/FASTQ manipulations
   * *bwa* for sequence alignment
   * *samtools* for manipulating SAM/BAM files
   * *skesa* for _de novo_ assembly


4. :microscope: **Inspect the reference**. Before starting your analyses, check the length and number of sequences in the refernce FASTA file, and open both the reference genome and its annotation using IGV. 

### Mapping and variant calling

By mapping the short reads against the reference genome we
can already get some insights, including visualising the mapping in IGV. Specialised tools can use the alignment file
to identify the differences with the reference (*variant calling*).

1. :card_index_dividers: **Map the reads**. Use `bwa mem` to map the reads against the reference genome (you will first need to index the genome). The output from *bwa* is text in SAM format, but we want sorted BAM files as output. Using pipes is a good way to do this. 

2. :mag: **Inspect the BAM files using IGV**. Can you have a feeling of the coverage and variants?

3. :dna: **Perform the variant calling**. Use *freebayes* to create a VCF file for each sample.


Notes

```bash
for FWD in reads/*_R1.fastq.gz;
do
   skesa --reads $FWD ${FWD/_R1/_R2} --contigs_out assembly-$(basename $FWD | cut -f 1 -d _) --cores  10;
done

for i in ass*;
do
   echo $i
   bwa mem -t 10 vir_genomic.fna $i | samtools view -bS | samtools sort --write-index -o $i.bam -
done

bwa index vir_genomic.fna
for FWD in reads/*_R1.fastq.gz;
do
   bwa mem -t 10 vir_genomic.fna $FWD ${FWD/_R1/_R2} | samtools view -bS | samtools sort --write-index -o map-$(basename $FWD | cut -f 1 -d _).bam -;
done


for BAM in *bam;
do
   freebayes -f vir_genomic.fna -C 3 -F 0.6 $BAM > var-$(basename $BAM | cut -f 1 -d _).vcf;
done
```

---


